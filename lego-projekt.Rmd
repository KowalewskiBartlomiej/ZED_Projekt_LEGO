---
title: "ZED - Projekt 1 <br>Analiza danych dotyczących LEGO"
author: "Bartłomiej Kowalewski, 145204"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    theme: paper
    number_sections: yes
    

knit: (function(inputFile, encoding) { 
          rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file='index.html') })
---

```{r ustawienia, include=F}
knitr::opts_chunk$set(echo=F, warning=F, message=F)
```

# Podsumowanie analizy

# Wykorzystane biblioteki

Do stworzenia raportu wykorzystano następujące biblioteki:

```{r ladowanie_bibliotek, echo=T}
library(knitr)
library(dplyr)
library(ggplot2)
library(skimr)
library(plotly)
library(caret)
library(ggeasy)
```

```{r setup_ladnych_tabel}
prettyTable <- function(table_df, round_digits=2) {
    DT::datatable(table_df, style="bootstrap", filter = "top", rownames = FALSE, extensions = "Buttons", options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>% formatRound(names(dplyr::select_if(table_df, is.numeric)), round_digits)
}
```

W celu uzyskania powtarzalności rezultatów ustawiono ziarno dla generatora liczb pseudolosowych.

```{r ustawienie_ziarna, echo=T}
set.seed(23)
```

# Wczytanie danych

Poniżej znajduje się kod odpowiedzialny za wczytanie danych z plików.

```{r wczytanie_danych, echo=T, cache=T}
inventories <- read.csv("rebrickable/inventories.csv")
inventory_parts <- read.csv("rebrickable/inventory_parts.csv")
parts <- read.csv("rebrickable/parts.csv")
part_categories <- read.csv("rebrickable/part_categories.csv")
part_relationships <- read.csv("rebrickable/part_relationships.csv")
elements <- read.csv("rebrickable/elements.csv")
colors <- read.csv("rebrickable/colors.csv")
inventory_minifigs <- read.csv("rebrickable/inventory_minifigs.csv")
minifigs <- read.csv("rebrickable/minifigs.csv")
inventory_sets <- read.csv("rebrickable/inventory_sets.csv")
sets <- read.csv("rebrickable/sets.csv")
themes <- read.csv("rebrickable/themes.csv")
```

# Opis zbioru danych

Cały zbiór danych dotyczący klocków LEGO składa się z 12 tabel. Poniżej znajdują się sekcje zawierające opisy każdej z nich, wyświetlające informacje o ich rozmiarze oraz podstawowe statystyki.

## Inventories

Jest to tabela nadrzędna łącząca części i figurki z zestawami LEGO.
<br> Tabela zawiera **`r nrow(inventories)`** rekordów.

Atrybuty w tej tabeli to:

* **id**
* **version** - numer wersji
* **set_num** - numer zestawu

```{r opis_danych_inventories}
kable(summary(inventories), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(inventories), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(inventories)
```

## Inventory Parts

W tej tabeli zostały zawarte informacje o zapasach (nakładach) części LEGO.
<br> Tabela zawiera **`r nrow(inventory_parts)`** rekordów.

Atrybuty w tej tabeli to:

* **inventory_id**
* **part_num** - oznaczenie części
* **color_id** - numer koloru
* **quantity** - ilość
* **is_spare** - zmienna typu bool, określająca czy klocek jest w zapasie
* **img_url** - adres url zdjęcia części

```{r opis_danych_inventory_parts}
kable(summary(inventory_parts), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(inventory_parts), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(inventory_parts)
```

## Parts

Tabela **parts** zawiera informacje o częściach LEGO, które mogą składać się z kilku elementów.
<br> Tabela zawiera **`r nrow(parts)`** rekordów.

Atrybuty w tej tabeli to:

* **part_num** - oznaczenie części
* **name** - nazwa części
* **part_cat_id** - id kategorii części
* **part_material** - materiał, z którego wykonano część

```{r opis_danych_parts}
kable(summary(parts), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(parts), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(parts)
```

## Part Categories

Tabela **part_categories** zawiera informacje o kategoriach części LEGO.
<br> Tabela zawiera **`r nrow(part_categories)`** rekordów.

Atrybuty w tej tabeli to:

* **id**
* **name** - nazwa kategorii części

```{r opis_danych_part_categories}
kable(summary(part_categories), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(part_categories), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(part_categories)
```

## Part Relationships

W tej tabeli zostały zawarte informacje o relacjach między poszczególnymi częściami.
<br> Tabela zawiera **`r nrow(part_relationships)`** rekordów.

Atrybuty w tej tabeli to:

* **rel_type** - oznaczenie relacji
* **child_part_num** - oznaczenie części "dziecka"
* **parent_part_num** - oznaczenie części "rodzica"

```{r opis_danych_part_relationships}
kable(summary(part_relationships), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(part_relationships), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(part_relationships)
```

## Elements

W tabeli **elements** znajdują się informacje o pojedynczych klockach LEGO.
<br> Tabela zawiera **`r nrow(elements)`** rekordów.

Atrybuty w tej tabeli to:

* **element_id**
* **part_num** - oznaczenie części, w której skład wchodzi dany element
* **color_id** - numer koloru
* **design_id**

```{r opis_danych_elements}
kable(summary(elements), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(elements), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(elements)
```

## Colors

Tabela **colors** zawiera informacje o oficjalnych kolorach klocków LEGO.
<br> Tabela zawiera **`r nrow(colors)`** rekordy.

Atrybuty w tej tabeli to:

* **id**
* **name** - nazwa koloru
* **rgb** - kolor zapisany w formacie RGB
* **is_trans** - zmienna typu bool, określająca czy kolor jest transparentny

```{r opis_danych_colors}
kable(summary(colors), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(colors), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(colors)
```

## Inventory Minifigs

W tej tabeli zawarte zostały informacje o zapasach (nakładzie) figurek LEGO.
<br> Tabela zawiera **`r nrow(inventory_minifigs)`** rekordów.

Atrybuty w tej tabeli to:

* **inventory_id**
* **fig_num** - oznaczenie figurki
* **quantity** - ilość

```{r opis_danych_inventory_minifigs}
kable(summary(inventory_minifigs), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(inventory_minifigs), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(inventory_minifigs)
```

## Minifigs

W tabela **minifigs** znajdują się informacje o figurkach LEGO.
<br> Tabela zawiera **`r nrow(minifigs)`** rekordy.

Atrybuty w tej tabeli to:

* **fig_num** - numer figurki
* **name** - nazwa figurki
* **num_parts** - liczba części
* **img_url** - adres url zdjęcia figurki

```{r opis_danych_minifigs}
kable(summary(minifigs), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(minifigs), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(minifigs)
```

## Inventory Sets

Tabela **inventory_sets** zawiera informacje o zapasach (nakładzie) zestawów LEGO.
<br> Tabela zawiera **`r nrow(inventory_sets)`** rekordów.

Atrybuty w tej tabeli to:

* **inventory_id**
* **set_num** - oznaczenie zestawu
* **quantity** - liczba

```{r opis_danych_inventory_sets}
kable(summary(inventory_sets), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(inventory_sets), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(inventory_sets)
```

## Sets

Tabela **sets** zawiera informacje o oficjalnych kolorach klocków LEGO.
<br> Tabela zawiera **`r nrow(sets)`** rekordów.

Atrybuty w tej tabeli to:

* **set_num** - oznaczenie zestawu
* **name** - nazwa zestawu
* **year** - rok, z którego pochodzi zestaw
* **theme_id** - numer kategorii zestawu
* **num_parts** - liczba części
* **img_url** - adres url zdjęcia zestawu

```{r opis_danych_sets}
kable(summary(sets), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(sets), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(sets)
```

## Themes

W tej tabeli zawarte zostały informacje o oryginalnych kategoriach zestawów, jak i o współpracach np. (Lego Star Wars).
<br> Tabela zawiera **`r nrow(themes)`** rekordów.

Atrybuty w tej tabeli to:

* **id**
* **name** - nazwa kategorii zestawu
* **parent_id** - numer kategorii "rodzica"

```{r opis_danych_themes}
kable(summary(themes), align = "l", caption = "Podstawowe statystyki danych z tabeli")
kable(head(themes), align = "l", caption = "Kilka pierwszych elementów z tabeli")
skim(themes)
```

# Analiza danych

W tej sekcji dokonano analizy wczytanych danych w celu wykrycia ciekawych zależności oraz znalezienia pojawiających się na przestrzeni lat trendów dotyczących klocków LEGO.

## Ogólna analiza

### Najpopularniejsze figurki w zestawach

Poniższy wykres przedstawia 10 najczęściej występujących figurek w zestawach LEGO.

```{r najpopularniejsze_figurki, echo=T}
inventory_minifigs %>%
  merge(inventories, by.x="inventory_id", by.y="id") %>%
  merge(minifigs, by="fig_num") %>%
  group_by(fig_num, name) %>%
  summarize(fig_count = n()) %>%
  arrange(desc(fig_count)) %>%
  mutate(name = strtrim(name, 20)) %>%
  head(10) %>%
  ggplot(aes(x = reorder(name, fig_count), y = fig_count)) + 
           geom_bar(stat="identity", fill="#00abff") +
           coord_flip() + 
           ggtitle("10 najpopularniejszych figurek") +
           labs(x = "Figurka", y = "Liczba zestawów, w których występuje figurka") +
           theme_bw() + 
           easy_center_title() -> pop_fig
  
ggplotly(pop_fig)
```

Z wykresu wynika, że najbardziej popularną figurką jest figurka szkieleta, która występuje w 43 zestawach.

### Rozkład materiałów, z których wykonano części

Poniżej znajduje się wykres kołowy oraz tabela podsumowująca procentowy rozkład materiałów, z których wykonano części LEGO. Niemalże wszystkie z nich (aż około 98,88%) zostały wykonane z plastiku. Następnym najczęściej używanym materiałem jest guma (około 0.71%).

```{r rozklad_materiałow, echo=T}
parts %>%
  merge(inventory_parts, by="part_num") %>%
  group_by(part_material) %>%
  summarize(material_count = n()) %>%
  arrange(desc(material_count)) %>%
  mutate(prop = material_count / sum(material_count)) -> parts_by_material

parts_by_material %>%
  mutate(ypos = cumsum(prop) - 0.5 * prop) %>%
  ggplot(aes(x="", y=prop, fill=part_material)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void()

parts_by_material %>%
  mutate(prop = formattable::percent(prop)) %>%
  kable(col.names = c("Materiał", "Liczba części", "Procent"))
```

### Najbardziej popularne kategorie zestawów

Poniżej znajduje się wykres przedstawiający 10 kategorii (motywy), w których jest najwięcej zestawów.

```{r najpopularniejsze_kategorie, echo=T}
themes %>%
  rename(theme_name = name) %>%
  merge(sets, by.x="id", by.y="theme_id") %>%
  group_by(theme_name) %>%
  summarize(theme_count = n()) %>%
  arrange(desc(theme_count)) %>%
  head(10) %>%
  ggplot(aes(x = reorder(theme_name, theme_count), y = theme_count)) + 
           geom_bar(stat="identity", fill="#00abff") +
           coord_flip() + 
           ggtitle("10 najpopularniejszych kategorii zestawów") +
           labs(x = "Kategoria zestawu", y = "Liczba zestawów w danej kategorii ") +
           theme_bw() + 
           easy_center_title() -> pop_themes
  
ggplotly(pop_themes)
```

Z powyższego wykresu wynika, że najpopularniejszą kategorią (motywem) jest Books, gdyż w tej kategorii są 973 zestawy.

## Analiza trendów

# Korelacje między zmiennymi

# Predykcja dalszych cech zestawów LEGO

# Kod - przetwarzanie danych 

# Szczegółowa analiza wartości atrybutów w zbiorze

# Interaktywne wykresy i animacje
